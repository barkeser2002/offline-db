name: âš¡ Senpai's Blind Trust (Auto-Merge ALL)

on:
  pull_request_target:
    # PR aÃ§Ä±ldÄ±ÄŸÄ±nda, gÃ¼ncellendiÄŸinde veya tekrar aÃ§Ä±ldÄ±ÄŸÄ±nda tetiklenir
    types: [opened, synchronize, reopened]

jobs:
  instant-merge:
    name: ğŸï¸ HÄ±zlÄ± ve Ã–fkeli Merge
    runs-on: ubuntu-latest
    permissions:
      contents: write      # Kodu birleÅŸtirmek (yazmak) iÃ§in
      pull-requests: write # PR'Ä± onaylamak ve kapatmak iÃ§in

    steps:
      - name: ğŸ¤– Senpai Operasyona BaÅŸlÄ±yor
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“¦ Sistem BaÄŸÄ±mlÄ±lÄ±klarÄ±
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
      
      - name: ğŸ”§ Conflict Ã‡Ã¶zÃ¼m Denemesi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          HEAD_REF: ${{ github.event.pull_request.head.ref }}
          BASE_REF: ${{ github.event.pull_request.base.ref }}
        run: |
          echo "ğŸ Senpai: Bir PR tespit edildi! Conflict ve Draft kontrolÃ¼ yapÄ±yorum..."
          
          # AdÄ±m 0: Durum verilerini Ã§ek (Hem mergeable durumu hem de draft durumu)
          # JSON Ã§Ä±ktÄ±sÄ±ndan iki veriyi de aynÄ± anda alÄ±yoruz
          PR_DATA=$(gh pr view "$PR_NUMBER" --json mergeable,isDraft)
          MERGEABLE_STATUS=$(echo "$PR_DATA" | jq -r .mergeable)
          IS_DRAFT=$(echo "$PR_DATA" | jq -r .isDraft)
          
          # jq yoksa alternatif (senin kullandÄ±ÄŸÄ±n yÃ¶ntemle ayrÄ± ayrÄ± Ã§ekim):
          if [ -z "$MERGEABLE_STATUS" ]; then
              MERGEABLE_STATUS=$(gh pr view "$PR_NUMBER" --json mergeable -q .mergeable)
              IS_DRAFT=$(gh pr view "$PR_NUMBER" --json isDraft -q .isDraft)
          fi
          
          if [ "$MERGEABLE_STATUS" = "MERGEABLE" ]; then
            echo "âœ… Kodda conflict yok. Draft durumu kontrol ediliyor..."
            
            # --- DÃœZELTME BAÅLANGICI ---
            # EÄŸer PR Draft ise, 'Ready for Review' durumuna Ã§ek
            if [ "$IS_DRAFT" = "true" ]; then
                echo "ğŸ“ PR ÅŸu an Draft modunda. Otomatik olarak 'Ready for review' yapÄ±lÄ±yor..."
                gh pr ready "$PR_URL"
                echo "ğŸ”“ PR draft modundan Ã§Ä±karÄ±ldÄ±."
            fi
            # --- DÃœZELTME BÄ°TÄ°ÅÄ° ---
            
            echo "ğŸš€ Ä°ÅŸlem devam ediyor..."
            
            # AdÄ±m 2: PR'Ä± onayla (Approve)
            gh pr review "$PR_URL" --approve --body "Senpai bu kodu beÄŸendi ve draft'tan Ã§Ä±karÄ±p onayladÄ±! ğŸš€"
            
            # AdÄ±m 3: Merge iÅŸlemini yap
            gh pr merge "$PR_URL" --squash --delete-branch
            
            echo "âœ… Ä°ÅŸlem Tamam! Kod artÄ±k ana yapÄ±nÄ±n bir parÃ§asÄ±."
            
          elif [ "$MERGEABLE_STATUS" = "CONFLICTING" ]; then
            echo "âŒ PR'da conflict var! Otomatik Ã§Ã¶zÃ¼m deniyorum..."
            
            # AdÄ±m 2: Conflict Ã§Ã¶zÃ¼m denemesi
            git fetch origin "$HEAD_REF"
            git checkout "$HEAD_REF"
            
            # Rebase dene
            if git rebase "origin/$BASE_REF"; then
              echo "âœ… Rebase baÅŸarÄ±lÄ±! Push ediyorum..."
              git push --force-with-lease origin "$HEAD_REF"
              
              sleep 5
              NEW_STATUS=$(gh pr view "$PR_NUMBER" --json mergeable -q .mergeable)
              
              if [ "$NEW_STATUS" = "MERGEABLE" ]; then
                # Rebase sonrasÄ± tekrar Draft kontrolÃ¼ yapmak iyi olur
                IS_DRAFT_RECHECK=$(gh pr view "$PR_NUMBER" --json isDraft -q .isDraft)
                if [ "$IS_DRAFT_RECHECK" = "true" ]; then
                     gh pr ready "$PR_URL"
                fi
                
                gh pr review "$PR_URL" --approve --body "Senpai conflict'leri Ã§Ã¶zdÃ¼ ve onayladÄ±! ğŸš€"
                gh pr merge "$PR_URL" --squash --delete-branch
                echo "âœ… Conflict Ã§Ã¶zÃ¼ldÃ¼ ve merge edildi!"
              else
                gh pr comment "$PR_URL" --body "ğŸ¤– **Otomatik Rebase Denendi** ama hala conflict var. LÃ¼tfen manuel Ã§Ã¶zÃ¼n."
              fi
            else
              echo "âŒ Rebase baÅŸarÄ±sÄ±z! Manuel Ã§Ã¶zÃ¼m gerekli..."
              git rebase --abort
              gh pr comment "$PR_URL" --body "ğŸš« **Conflict Tespit Edildi!** Otomatik Ã§Ã¶zÃ¼m baÅŸarÄ±sÄ±z."
            fi
            
          else
            echo "â³ PR henÃ¼z hazÄ±r deÄŸil ($MERGEABLE_STATUS). Biraz bekleyip tekrar dene..."
            gh pr comment "$PR_URL" --body "â³ PR henÃ¼z merge edilebilir durumda deÄŸil."
          fi
