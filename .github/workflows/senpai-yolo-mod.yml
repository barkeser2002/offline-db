name: âš¡ Senpai's Blind Trust (Auto-Merge ALL)

on:
  pull_request_target:
    # PR aÃ§Ä±ldÄ±ÄŸÄ±nda, gÃ¼ncellendiÄŸinde veya tekrar aÃ§Ä±ldÄ±ÄŸÄ±nda tetiklenir
    types: [opened, synchronize, reopened]

jobs:
  instant-merge:
    name: ğŸï¸ HÄ±zlÄ± ve Ã–fkeli Merge
    runs-on: ubuntu-latest
    permissions:
      contents: write      # Kodu birleÅŸtirmek (yazmak) iÃ§in
      pull-requests: write # PR'Ä± onaylamak ve kapatmak iÃ§in

    steps:
      - name: ğŸ¤– Senpai Operasyona BaÅŸlÄ±yor
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ”§ Conflict Ã‡Ã¶zÃ¼m Denemesi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          HEAD_REF: ${{ github.event.pull_request.head.ref }}
          BASE_REF: ${{ github.event.pull_request.base.ref }}
        run: |
          echo "ğŸ Senpai: Bir PR tespit edildi! Conflict kontrolÃ¼ yapÄ±yorum..."
          
          # AdÄ±m 1: PR'Ä±n mergeable durumunu kontrol et
          MERGEABLE_STATUS=$(gh pr view "$PR_NUMBER" --json mergeable -q .mergeable)
          
          if [ "$MERGEABLE_STATUS" = "MERGEABLE" ]; then
            echo "âœ… PR merge edilebilir! Ä°ÅŸlem devam ediyor..."
            
            # AdÄ±m 2: PR'Ä± onayla (Approve) - BazÄ± branch korumalarÄ± onay ister
            gh pr review "$PR_URL" --approve --body "Senpai bu kodu beÄŸendi ve hiÃ§ okumadan onayladÄ±! ğŸš€"
            
            # AdÄ±m 3: Merge iÅŸlemini yap (Squash ile tek parÃ§a halinde)
            gh pr merge "$PR_URL" --squash --delete-branch
            
            echo "âœ… Ä°ÅŸlem Tamam! Kod artÄ±k ana yapÄ±nÄ±n bir parÃ§asÄ±."
            
          elif [ "$MERGEABLE_STATUS" = "CONFLICTING" ]; then
            echo "âŒ PR'da conflict var! Otomatik Ã§Ã¶zÃ¼m deniyorum..."
            
            # AdÄ±m 2: Conflict Ã§Ã¶zÃ¼m denemesi
            # PR branch'ini checkout et
            git fetch origin "$HEAD_REF"
            git checkout "$HEAD_REF"
            
            # Rebase dene
            if git rebase "origin/$BASE_REF"; then
              echo "âœ… Rebase baÅŸarÄ±lÄ±! Push ediyorum..."
              git push --force-with-lease origin "$HEAD_REF"
              
              # Tekrar mergeable kontrolÃ¼
              sleep 5
              NEW_STATUS=$(gh pr view "$PR_NUMBER" --json mergeable -q .mergeable)
              
              if [ "$NEW_STATUS" = "MERGEABLE" ]; then
                gh pr review "$PR_URL" --approve --body "Senpai conflict'leri otomatik Ã§Ã¶zdÃ¼ ve onayladÄ±! ğŸš€"
                gh pr merge "$PR_URL" --squash --delete-branch
                echo "âœ… Conflict Ã§Ã¶zÃ¼ldÃ¼ ve merge edildi!"
              else
                gh pr comment "$PR_URL" --body "ğŸ¤– **Otomatik Rebase Denendi** ama hala conflict var. LÃ¼tfen manuel olarak Ã§Ã¶zÃ¼n."
              fi
            else
              echo "âŒ Rebase baÅŸarÄ±sÄ±z! Manuel Ã§Ã¶zÃ¼m gerekli..."
              git rebase --abort
              gh pr comment "$PR_URL" --body "ğŸš« **Conflict Tespit Edildi!** Otomatik Ã§Ã¶zÃ¼m baÅŸarÄ±sÄ±z. LÃ¼tfen conflict'leri manuel olarak Ã§Ã¶zÃ¼n ve tekrar push edin."
            fi
            
          else
            echo "â³ PR henÃ¼z hazÄ±r deÄŸil ($MERGEABLE_STATUS). Biraz bekleyip tekrar dene..."
            gh pr comment "$PR_URL" --body "â³ PR henÃ¼z merge edilebilir durumda deÄŸil. Check'ler tamamlandÄ±ktan sonra tekrar deneyeceÄŸim..."
          fi
