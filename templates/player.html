{% extends 'base.html' %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <div class="mb-4">
        <h1 class="text-3xl font-bold text-white">{{ episode.season.anime.title }}</h1>
        <h2 class="text-xl text-gray-400">Season {{ episode.season.number }} - Episode {{ episode.number }} {% if episode.title %}: {{ episode.title }}{% endif %}</h2>
    </div>

    <div class="relative w-full pb-[56.25%] bg-black rounded-xl overflow-hidden shadow-2xl border border-gray-800">
        {% if video %}
            <video id="player" playsinline controls class="absolute top-0 left-0 w-full h-full"></video>

            <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
            <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

            <script>
                document.addEventListener('DOMContentLoaded', () => {
                    const video = document.getElementById('player');
                    // Construct URL assuming standard media structure
                    const source = "/media/videos/{{ episode.id }}/{{ video.quality }}/index.m3u8";

                    if (Hls.isSupported()) {
                        const hls = new Hls({
                            xhrSetup: function(xhr, url) {
                                // Prepare for key loading with cookies/auth if needed
                                xhr.withCredentials = true;
                            }
                        });
                        hls.loadSource(source);
                        hls.attachMedia(video);
                    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                        video.src = source;
                    }

                    const player = new Plyr(video, {
                        controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'],
                    });
                });
            </script>
        {% else %}
            <div class="absolute top-0 left-0 w-full h-full flex items-center justify-center text-red-500 font-bold bg-gray-900">
                VIDEO SOURCE NOT FOUND
            </div>
        {% endif %}
    </div>

    <div class="mt-6 p-4 bg-gray-800 rounded-lg">
        <h3 class="font-bold text-lg mb-2">Details</h3>
        <p class="text-gray-400">{{ episode.season.anime.synopsis|truncatewords:50 }}</p>
        {% if video.fansub_group %}
        <p class="mt-2 text-sm text-brand">Fansub: {{ video.fansub_group.name }}</p>
        {% endif %}
    </div>
</div>
{% endblock %}
