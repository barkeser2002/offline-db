<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ anime.title }} - Anime Player</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
            min-height: 100vh;
            color: #fff;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        .header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .header img {
            width: 120px;
            height: 170px;
            object-fit: cover;
            border-radius: 10px;
        }
        .header-info h1 { color: #e94560; margin-bottom: 10px; font-size: 1.5em; }
        .header-info p { color: rgba(255,255,255,0.7); margin-bottom: 5px; }
        .back-btn {
            display: inline-block;
            padding: 8px 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            color: #fff;
            text-decoration: none;
            margin-bottom: 10px;
        }
        .back-btn:hover { background: rgba(255,255,255,0.2); }

        .player-container {
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
        }
        #videoPlayer {
            width: 100%;
            max-height: 75vh;
            display: block;
        }

        .player-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.9));
            padding: 20px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .player-container:hover .player-controls { opacity: 1; }

        .progress-bar {
            width: 100%;
            height: 5px;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .progress-bar .progress {
            height: 100%;
            background: #e94560;
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s;
        }

        .control-buttons {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .ctrl-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }
        .ctrl-btn:hover { color: #e94560; }

        .time-display {
            font-size: 12px;
            color: rgba(255,255,255,0.8);
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-left: auto;
        }
        .volume-slider {
            width: 80px;
            height: 4px;
            -webkit-appearance: none;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
        }
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: #e94560;
            border-radius: 50%;
            cursor: pointer;
        }

        .fullscreen-btn { margin-left: 15px; }

        .source-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .source-selector label {
            font-size: 14px;
            color: rgba(255,255,255,0.7);
        }
        .source-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            color: #fff;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        .source-btn.active {
            background: linear-gradient(135deg, #e94560, #8b5cf6);
            border-color: transparent;
        }
        .source-btn:hover {
            background: rgba(233, 69, 96, 0.3);
            border-color: #e94560;
        }
        .source-btn .quality-badge {
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 5px;
        }

        .episodes-section h3 {
            margin-bottom: 15px;
            color: #e94560;
        }
        .episodes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .ep-btn {
            width: 50px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
        }
        .ep-btn:hover { background: rgba(233, 69, 96, 0.5); transform: scale(1.1); }
        .ep-btn.active { background: #e94560; }
        .ep-btn.has-video { border: 2px solid #4CAF50; }

        .loading {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            padding: 20px 40px;
            border-radius: 10px;
            z-index: 100;
        }
        .loading.show { display: block; }
        .loading .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.2);
            border-top-color: #e94560;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .error-message {
            display: none;
            text-align: center;
            padding: 40px;
            color: #e94560;
        }
        .error-message.show { display: block; }

        .player-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 400px;
            background: #111;
            color: rgba(255,255,255,0.5);
            font-size: 18px;
        }

        /* Iframe Player */
        .iframe-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 */
            display: none;
        }
        .iframe-container.show { display: block; }
        .iframe-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Native Video */
        .video-container {
            display: none;
        }
        .video-container.show { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-btn">‚Üê Ana Sayfa</a>

        <div class="header">
            {% if anime.cover_local %}
            <img src="/covers/{{ anime.cover_local.split('/')[-1] }}" alt="{{ anime.title }}">
            {% elif anime.cover_url %}
            <img src="{{ anime.cover_url }}" alt="{{ anime.title }}">
            {% endif %}
            <div class="header-info">
                <h1>{{ anime.title }}</h1>
                <p>üì∫ {{ anime.type or 'TV' }} | üìÖ {{ anime.year or '?' }} | ‚≠ê {{ anime.score or '?' }}</p>
                <p>üìù {{ anime.episodes or '?' }} B√∂l√ºm | MAL ID: {{ anime.mal_id }}</p>
                <div style="margin-top: 10px; font-size: 13px; opacity: 0.8; max-height: 60px; overflow-y: auto;">
                    {{ anime.synopsis[:300] if anime.synopsis else '' }}...
                </div>
            </div>
        </div>

        <div class="player-container" id="playerContainer">
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>Video y√ºkleniyor...</div>
            </div>

            <div class="error-message" id="errorMessage">
                ‚ùå Video y√ºklenemedi
                <br><small>Farklƒ± bir kaynak deneyin</small>
            </div>

            <div class="player-placeholder" id="placeholder">
                üé¨ Bir b√∂l√ºm se√ßin veya kaynak bekleyin...
            </div>

            <!-- Native HTML5 Video + HLS.js -->
            <div class="video-container" id="videoContainer">
                <video id="videoPlayer" controls playsinline>
                    Tarayƒ±cƒ±nƒ±z video oynatmayƒ± desteklemiyor.
                </video>
            </div>

            <!-- Iframe Player (Embed i√ßin) -->
            <div class="iframe-container" id="iframeContainer">
                <iframe id="iframePlayer" allowfullscreen allow="autoplay; encrypted-media"></iframe>
            </div>
        </div>

        <div class="source-selector" id="sourceSelector">
            <label>üé¨ Kaynaklar:</label>
        </div>

        <div class="episodes-section">
            <h3>üì∫ B√∂l√ºmler</h3>
            <div class="episodes" id="episodeList">
                {% for ep in episodes %}
                <button class="ep-btn {% if ep.episode_number == current_ep %}active{% endif %} {% if ep.has_video %}has-video{% endif %}"
                        onclick="loadEpisode({{ ep.episode_number }})"
                        title="{{ ep.title }}">
                    {{ ep.episode_number }}
                </button>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- HLS.js for HLS streams -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <script>
        const malId = {{ anime.mal_id }};
        let currentEp = {{ current_ep }};
        let currentVideos = [];
        let hls = null;

        const videoPlayer = document.getElementById('videoPlayer');
        const iframePlayer = document.getElementById('iframePlayer');
        const videoContainer = document.getElementById('videoContainer');
        const iframeContainer = document.getElementById('iframeContainer');
        const placeholder = document.getElementById('placeholder');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('errorMessage');
        const sourceSelector = document.getElementById('sourceSelector');

        // Sayfa y√ºklendiƒüinde
        document.addEventListener('DOMContentLoaded', function() {
            if (currentEp > 0) {
                loadEpisode(currentEp);
            }
        });

        async function loadEpisode(epNum) {
            currentEp = epNum;

            // Aktif butonu g√ºncelle
            document.querySelectorAll('.ep-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.textContent) === epNum);
            });

            // URL g√ºncelle
            history.pushState({}, '', `/player?mal_id=${malId}&ep=${epNum}`);

            // Reset UI
            hideAll();
            loading.classList.add('show');

            try {
                const response = await fetch(`/api/stream/${malId}/${epNum}`);
                const data = await response.json();

                loading.classList.remove('show');

                if (data.videos && data.videos.length > 0) {
                    currentVideos = data.videos;
                    updateSourceSelector(data.videos);
                    playVideo(data.videos[0]);
                } else {
                    showError('Bu b√∂l√ºm i√ßin video bulunamadƒ±');
                }
            } catch (error) {
                console.error('Video y√ºkleme hatasƒ±:', error);
                loading.classList.remove('show');
                showError('Video y√ºklenirken hata olu≈ütu');
            }
        }

        function updateSourceSelector(videos) {
            // Fansub'a g√∂re grupla
            const grouped = {};
            videos.forEach(v => {
                const key = v.fansub || 'Bilinmeyen';
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(v);
            });

            let html = '<label>üé¨ Kaynaklar:</label>';
            let index = 0;

            for (const [fansub, vids] of Object.entries(grouped)) {
                vids.forEach(v => {
                    const quality = v.quality || 'Auto';
                    const isActive = index === 0 ? 'active' : '';
                    html += `<button class="source-btn ${isActive}" onclick="selectSource(${index})" data-index="${index}">
                        ${fansub} <span class="quality-badge">${quality}</span>
                    </button>`;
                    index++;
                });
            }

            sourceSelector.innerHTML = html;
        }

        function selectSource(index) {
            if (index >= 0 && index < currentVideos.length) {
                // Aktif butonu g√ºncelle
                document.querySelectorAll('.source-btn').forEach(btn => {
                    btn.classList.toggle('active', parseInt(btn.dataset.index) === index);
                });

                playVideo(currentVideos[index]);
            }
        }

        function playVideo(video) {
            hideAll();

            const streamUrl = video.stream_url || video.video_url;
            console.log('Playing:', streamUrl, 'Type:', video.type);

            // URL tipini belirle
            const isHLS = streamUrl.includes('.m3u8') || video.type === 'hls';
            const isEmbed = streamUrl.includes('iframe') ||
                           streamUrl.includes('embed') ||
                           streamUrl.includes('player') ||
                           streamUrl.includes('sibnet') ||
                           streamUrl.includes('tau-video') ||
                           streamUrl.includes('anizmplayer');

            if (isEmbed && !isHLS) {
                // Embed/Iframe player
                playIframe(streamUrl);
            } else if (isHLS) {
                // HLS Stream
                playHLS(streamUrl);
            } else {
                // Direct MP4/Video
                playDirect(streamUrl);
            }
        }

        function playIframe(url) {
            iframeContainer.classList.add('show');
            iframePlayer.src = url;
        }

        function playHLS(url) {
            videoContainer.classList.add('show');

            // √ñnceki HLS instance'ƒ± temizle
            if (hls) {
                hls.destroy();
                hls = null;
            }

            if (Hls.isSupported()) {
                hls = new Hls({
                    debug: false,
                    enableWorker: true,
                    lowLatencyMode: true,
                    backBufferLength: 90
                });

                hls.loadSource(url);
                hls.attachMedia(videoPlayer);

                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    videoPlayer.play().catch(e => console.log('Autoplay engellendi:', e));
                });

                hls.on(Hls.Events.ERROR, function(event, data) {
                    if (data.fatal) {
                        console.error('HLS Fatal Error:', data);
                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                // Aƒü hatasƒ± - yeniden dene
                                console.log('Network error, trying to recover...');
                                hls.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                // Media hatasƒ± - kurtarmaya √ßalƒ±≈ü
                                console.log('Media error, trying to recover...');
                                hls.recoverMediaError();
                                break;
                            default:
                                showError('Video oynatƒ±lamadƒ± - farklƒ± kaynak deneyin');
                                break;
                        }
                    }
                });
            } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                // Safari native HLS
                videoPlayer.src = url;
                videoPlayer.addEventListener('loadedmetadata', function() {
                    videoPlayer.play().catch(e => console.log('Autoplay engellendi:', e));
                });
            } else {
                showError('Tarayƒ±cƒ±nƒ±z HLS desteklemiyor');
            }
        }

        function playDirect(url) {
            videoContainer.classList.add('show');

            if (hls) {
                hls.destroy();
                hls = null;
            }

            videoPlayer.src = url;
            videoPlayer.load();
            videoPlayer.play().catch(e => console.log('Autoplay engellendi:', e));

            videoPlayer.onerror = function() {
                showError('Video oynatƒ±lamadƒ± - farklƒ± kaynak deneyin');
            };
        }

        function hideAll() {
            videoContainer.classList.remove('show');
            iframeContainer.classList.remove('show');
            placeholder.style.display = 'none';
            errorMessage.classList.remove('show');
            loading.classList.remove('show');

            // Video durdur
            videoPlayer.pause();
            videoPlayer.src = '';
            iframePlayer.src = '';
        }

        function showError(msg) {
            errorMessage.innerHTML = `‚ùå ${msg}<br><small>Farklƒ± bir kaynak deneyin</small>`;
            errorMessage.classList.add('show');
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT') return;

            switch(e.key) {
                case 'ArrowRight':
                    if (e.shiftKey && currentEp < {{ episodes|length }}) {
                        loadEpisode(currentEp + 1);
                    } else {
                        videoPlayer.currentTime += 10;
                    }
                    break;
                case 'ArrowLeft':
                    if (e.shiftKey && currentEp > 1) {
                        loadEpisode(currentEp - 1);
                    } else {
                        videoPlayer.currentTime -= 10;
                    }
                    break;
                case ' ':
                    e.preventDefault();
                    videoPlayer.paused ? videoPlayer.play() : videoPlayer.pause();
                    break;
                case 'f':
                    toggleFullscreen();
                    break;
            }
        });

        function toggleFullscreen() {
            const container = document.getElementById('playerContainer');
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                container.requestFullscreen();
            }
        }
    </script>
</body>
</html>
