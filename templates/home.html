{% extends "base.html" %}

{% block content %}
    <!-- Hero Section -->
    <section class="relative rounded-3xl overflow-hidden mb-12 min-h-[400px] flex items-center shadow-2xl ring-1 ring-white/10 group">
        <!-- Animated Background -->
        <div class="absolute inset-0 bg-[url('https://images7.alphacoders.com/133/1330715.png')] bg-cover bg-center transition-transform duration-[20s] group-hover:scale-110"></div>
        <div class="absolute inset-0 bg-gradient-to-r from-[#0a0a0f] via-[#0a0a0f]/80 to-transparent"></div>
        <div class="absolute inset-0 bg-gradient-to-t from-[#0a0a0f] via-transparent to-transparent"></div>

        <div class="relative z-10 p-8 md:p-12 lg:p-16 max-w-3xl">
            <span class="inline-block py-1 px-3 rounded-full bg-purple-600/20 text-purple-400 text-xs font-bold tracking-widest border border-purple-500/30 mb-4 backdrop-blur-md">
                NEXT GEN PLATFORM
            </span>
            <h1 class="text-5xl md:text-7xl font-extrabold text-white leading-tight mb-6 drop-shadow-lg">
                Discover the <br>
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-cyan-400 animate-pulse">Unknown.</span>
            </h1>
            <p class="text-gray-300 text-lg mb-8 max-w-xl leading-relaxed">
                Dive into a massive collection of anime. Track your progress, discover hidden gems, and join a community of enthusiasts.
            </p>
            <div class="flex flex-wrap gap-4">
                <a href="/discover" class="px-8 py-3.5 rounded-xl bg-white text-black font-bold text-lg hover:bg-gray-200 transition transform hover:-translate-y-1 shadow-lg shadow-white/20">
                    Start Exploring
                </a>
                <a href="/register" class="px-8 py-3.5 rounded-xl bg-white/10 text-white font-bold text-lg backdrop-blur-md border border-white/10 hover:bg-white/20 transition transform hover:-translate-y-1">
                    Join Now
                </a>
            </div>
        </div>
    </section>

    <!-- Stats Strip -->
    <section class="grid grid-cols-3 gap-4 md:gap-8 mb-16 max-w-4xl mx-auto">
        <div class="glass rounded-2xl p-6 text-center transform hover:scale-105 transition duration-300 border border-white/5">
            <p class="text-3xl md:text-4xl font-black text-transparent bg-clip-text bg-gradient-to-br from-blue-400 to-indigo-500">{{ stats.anime_count }}</p>
            <p class="text-gray-400 uppercase text-[10px] tracking-[0.2em] mt-2 font-bold">Animes</p>
        </div>
        <div class="glass rounded-2xl p-6 text-center transform hover:scale-105 transition duration-300 border border-white/5">
            <p class="text-3xl md:text-4xl font-black text-transparent bg-clip-text bg-gradient-to-br from-green-400 to-emerald-500">{{ stats.episode_count }}</p>
            <p class="text-gray-400 uppercase text-[10px] tracking-[0.2em] mt-2 font-bold">Episodes</p>
        </div>
        <div class="glass rounded-2xl p-6 text-center transform hover:scale-105 transition duration-300 border border-white/5">
            <p class="text-3xl md:text-4xl font-black text-transparent bg-clip-text bg-gradient-to-br from-purple-400 to-pink-500">{{ stats.video_count }}</p>
            <p class="text-gray-400 uppercase text-[10px] tracking-[0.2em] mt-2 font-bold">Streams</p>
        </div>
    </section>

    <!-- Content Sections Helper (Macro-like structure via include not possible easily without separate files, so repetition is okay for now) -->

    <!-- Trending Section -->
    <section class="mb-16 hidden" id="trending-section">
        <div class="flex items-center justify-between mb-8">
            <h2 class="text-2xl md:text-3xl font-bold text-white flex items-center gap-3">
                <span class="w-1.5 h-8 rounded-full bg-gradient-to-b from-orange-400 to-red-500 block"></span>
                Trending Now
            </h2>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6" id="trending-container">
            <!-- Loaded via JS -->
        </div>
    </section>

    {% if session.user_id %}
        <!-- Continue Watching -->
        {% if user_history %}
        <section class="mb-16">
            <div class="flex items-center justify-between mb-8">
                 <h2 class="text-2xl md:text-3xl font-bold text-white flex items-center gap-3">
                    <span class="w-1.5 h-8 rounded-full bg-gradient-to-b from-yellow-400 to-amber-500 block"></span>
                    Continue Watching
                </h2>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                {% for entry in user_history %}
                <a href="/anime/{{ entry.mal_id }}" class="anime-card block relative group rounded-xl overflow-hidden bg-[#1c1c2e] ring-1 ring-white/5">
                    <div class="aspect-[2/3] w-full relative overflow-hidden">
                        <img src="{{ entry.cover_local or entry.cover_url }}" alt="{{ entry.title }}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110 group-hover:opacity-75">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent opacity-60"></div>

                        <!-- Progress Bar -->
                        <div class="absolute bottom-0 left-0 w-full h-1 bg-gray-700/50">
                             <div class="h-full bg-blue-500 shadow-[0_0_10px_rgba(59,130,246,0.5)]" style="width: {{ entry.progress_percent }}%"></div>
                        </div>

                        <!-- Play Icon Overlay -->
                         <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition duration-300 transform scale-50 group-hover:scale-100">
                             <div class="w-12 h-12 rounded-full bg-white/20 backdrop-blur-md flex items-center justify-center border border-white/30">
                                <svg class="w-6 h-6 text-white ml-1" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path></svg>
                             </div>
                        </div>
                    </div>
                    <div class="p-4 relative">
                        <h3 class="font-bold text-gray-100 truncate text-sm group-hover:text-blue-400 transition">{{ entry.title }}</h3>
                        <p class="text-xs text-gray-500 mt-1 font-mono">Ep {{ entry.episode_number }}</p>
                    </div>
                </a>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <!-- Watchlist -->
        {% if user_watchlist %}
        <section class="mb-16">
            <div class="flex items-center justify-between mb-8">
                 <h2 class="text-2xl md:text-3xl font-bold text-white flex items-center gap-3">
                    <span class="w-1.5 h-8 rounded-full bg-gradient-to-b from-blue-400 to-indigo-500 block"></span>
                    My Watchlist
                </h2>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                {% for entry in user_watchlist %}
                <a href="/anime/{{ entry.mal_id }}" class="anime-card block relative group rounded-xl overflow-hidden bg-[#1c1c2e] ring-1 ring-white/5">
                    <div class="aspect-[2/3] w-full relative overflow-hidden">
                        <img src="{{ entry.cover_local or entry.cover_url }}" alt="{{ entry.title }}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
                        <div class="absolute top-2 right-2 px-2 py-1 rounded-md bg-black/60 backdrop-blur-md border border-white/10 text-[10px] font-bold text-white uppercase tracking-wider">
                            {{ entry.status.replace('-', ' ') }}
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold text-gray-100 truncate text-sm group-hover:text-blue-400 transition">{{ entry.title }}</h3>
                        <div class="flex items-center gap-1 mt-2">
                             <svg class="w-3 h-3 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                             <span class="text-xs text-gray-400 font-bold">{{ entry.score }}</span>
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <!-- For You -->
        {% if user_recommendations %}
        <section class="mb-16">
            <div class="flex items-center justify-between mb-8">
                 <h2 class="text-2xl md:text-3xl font-bold text-white flex items-center gap-3">
                    <span class="w-1.5 h-8 rounded-full bg-gradient-to-b from-green-400 to-emerald-500 block"></span>
                    For You
                </h2>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                {% for anime in user_recommendations %}
                <a href="/player?mal_id={{ anime.mal_id }}" class="anime-card block relative group rounded-xl overflow-hidden bg-[#1c1c2e] ring-1 ring-white/5">
                    <div class="aspect-[2/3] w-full relative overflow-hidden">
                        <img src="{{ anime.cover_local or anime.cover_url }}" alt="{{ anime.title }}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition duration-300 flex items-end p-4">
                            <p class="text-xs text-gray-300 line-clamp-3">{{ anime.synopsis }}</p>
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold text-gray-100 truncate text-sm group-hover:text-green-400 transition">{{ anime.title }}</h3>
                        <div class="flex items-center justify-between mt-2">
                             <span class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">{{ anime.type }}</span>
                             <div class="flex items-center gap-1">
                                <svg class="w-3 h-3 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                                <span class="text-xs text-gray-300 font-bold">{{ anime.score }}</span>
                             </div>
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>
        </section>
        {% endif %}
    {% endif %}

    <!-- Personalized Recommendations -->
    <section class="mb-16 hidden" id="recommendations-section">
        <div class="flex items-center justify-between mb-8">
             <h2 class="text-2xl md:text-3xl font-bold text-white flex items-center gap-3">
                <span class="w-1.5 h-8 rounded-full bg-gradient-to-b from-indigo-400 to-purple-500 block"></span>
                Recommended for You
            </h2>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6" id="recommendations-container">
            <!-- Loaded via JS -->
        </div>
    </section>

    <!-- Local Trending -->
    {% if local_trending %}
    <section class="mb-16">
        <div class="flex items-center justify-between mb-8">
             <h2 class="text-2xl md:text-3xl font-bold text-white flex items-center gap-3">
                <span class="w-1.5 h-8 rounded-full bg-gradient-to-b from-purple-400 to-fuchsia-500 block"></span>
                Trending on AniScrap
            </h2>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
            {% for anime in local_trending %}
            <a href="/anime/{{ anime.mal_id }}" class="anime-card block relative group rounded-xl overflow-hidden bg-[#1c1c2e] ring-1 ring-white/5">
                <div class="aspect-[2/3] w-full relative overflow-hidden">
                    <img src="{{ anime.cover_local or anime.cover_url }}" alt="{{ anime.title }}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
                    <div class="absolute top-2 left-2 px-2 py-1 rounded-md bg-purple-600/80 backdrop-blur-md text-[10px] font-bold text-white uppercase tracking-wider shadow-lg">
                        {{ anime.watch_count }} Views
                    </div>
                </div>
                <div class="p-4">
                    <h3 class="font-bold text-gray-100 truncate text-sm group-hover:text-purple-400 transition">{{ anime.title }}</h3>
                    <div class="flex items-center justify-between mt-2">
                        <span class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">{{ anime.type }}</span>
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- Seasons -->
    <section class="bg-gradient-to-br from-[#1c1c2e] to-[#151520] p-8 rounded-3xl mb-16 border border-white/5 relative overflow-hidden group">
        <div class="absolute top-0 right-0 w-64 h-64 bg-purple-600/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 group-hover:bg-purple-600/20 transition duration-1000"></div>
        <h2 class="text-2xl font-bold text-white mb-6 relative z-10">Browse by Season</h2>
        <div class="flex flex-wrap gap-3 relative z-10">
            {% for s in seasons[:15] %}
                <a href="/season/{{ s.year }}/{{ s.season }}" class="px-4 py-2 rounded-lg bg-white/5 hover:bg-white/10 text-gray-300 hover:text-white text-sm font-medium transition border border-white/5 hover:border-white/20">
                    {{ s.year }} {{ s.season.title() }}
                </a>
            {% endfor %}
        </div>
    </section>

    <!-- Top Anime -->
    <section class="mb-16">
        <div class="flex items-center justify-between mb-8">
             <h2 class="text-2xl md:text-3xl font-bold text-white flex items-center gap-3">
                <span class="w-1.5 h-8 rounded-full bg-gradient-to-b from-red-400 to-rose-500 block"></span>
                Top Rated Anime
            </h2>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
            {% for anime in top_anime %}
            <a href="/anime/{{ anime.mal_id }}" class="anime-card block relative group rounded-xl overflow-hidden bg-[#1c1c2e] ring-1 ring-white/5">
                <div class="aspect-[2/3] w-full relative overflow-hidden">
                    <img src="{{ anime.images.jpg.large_image_url }}" alt="{{ anime.title }}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
                    <div class="absolute top-2 right-2 flex items-center justify-center w-8 h-8 rounded-full bg-black/60 backdrop-blur-md border border-yellow-500/30 text-xs font-bold text-yellow-500 shadow-lg">
                        {{ anime.score }}
                    </div>
                </div>
                <div class="p-4">
                    <h3 class="font-bold text-gray-100 truncate text-sm group-hover:text-red-400 transition">{{ anime.title }}</h3>
                </div>
            </a>
            {% endfor %}
        </div>
    </section>
{% endblock %}

{% block scripts %}
<script>
    function createCard(anime, type = 'standard') {
        const cover = anime.cover_local ? `/covers/${anime.mal_id}.jpg` : anime.cover_url;
        // Adjust for different API responses structure if needed
        const score = anime.score || 'N/A';
        const title = anime.title;
        const mal_id = anime.mal_id;

        let extraBadge = '';
        if (type === 'trending') {
            extraBadge = `
                <div class="absolute top-2 left-2 px-2 py-1 rounded-md bg-orange-600/80 backdrop-blur-md text-[10px] font-bold text-white uppercase tracking-wider shadow-lg">
                    ðŸ”¥ ${anime.watch_count || ''}
                </div>
            `;
        }

        return `
            <a href="/anime/${mal_id}" class="anime-card block relative group rounded-xl overflow-hidden bg-[#1c1c2e] ring-1 ring-white/5">
                <div class="aspect-[2/3] w-full relative overflow-hidden">
                    <img src="${cover}" alt="${title}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
                    ${extraBadge}
                    <div class="absolute bottom-0 left-0 w-full h-1/2 bg-gradient-to-t from-black/90 to-transparent opacity-60"></div>
                </div>
                <div class="p-4 relative">
                    <h3 class="font-bold text-gray-100 truncate text-sm group-hover:text-purple-400 transition">${title}</h3>
                    <div class="flex items-center justify-between mt-2">
                        <span class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">${anime.type || 'TV'}</span>
                        <div class="flex items-center gap-1">
                            <svg class="w-3 h-3 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                            <span class="text-xs text-gray-300 font-bold">${score}</span>
                        </div>
                    </div>
                </div>
            </a>
        `;
    }

    async function loadTrending() {
        const section = document.getElementById('trending-section');
        const container = document.getElementById('trending-container');
        try {
            const resp = await fetch('/api/social/trending?limit=6');
            const data = await resp.json();

            if (data && data.length > 0) {
                section.classList.remove('hidden');
                container.innerHTML = data.map(anime => createCard(anime, 'trending')).join('');
            }
        } catch (e) {
            console.error('Error loading trending:', e);
        }
    }

    async function loadPersonalizedRecommendations() {
        const section = document.getElementById('recommendations-section');
        const container = document.getElementById('recommendations-container');
        try {
            const resp = await fetch('/api/social/recommendations?limit=6');
            const data = await resp.json();

            if (data && data.success && data.recommendations.length > 0) {
                section.classList.remove('hidden');
                container.innerHTML = data.recommendations.map(anime => createCard(anime)).join('');
            }
        } catch (e) {
            console.error('Error loading recommendations:', e);
        }
    }

    loadTrending();
    loadPersonalizedRecommendations();
</script>
{% endblock %}
