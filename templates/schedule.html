{% extends "base.html" %}

{% block title %}Simulcast Schedule - Senpai Anime{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex flex-col md:flex-row justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-white mb-2">Simulcast Calendar</h1>
            <p class="text-gray-400">Find out when your favorite anime is airing this week.</p>
        </div>
        <div class="mt-4 md:mt-0 flex space-x-2 bg-gray-800 p-1 rounded-lg">
            {% for day in days %}
            <button
                onclick="switchDay('{{ day }}')"
                id="tab-{{ day }}"
                class="day-tab px-4 py-2 rounded-md text-sm font-medium transition-colors {% if day == today %}bg-indigo-600 text-white shadow-lg{% else %}text-gray-400 hover:text-white hover:bg-gray-700{% endif %}"
            >
                {{ day|capitalize }}
            </button>
            {% endfor %}
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading-spinner" class="flex justify-center items-center py-20">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500"></div>
    </div>

    <!-- Content -->
    <div id="schedule-content" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 hidden">
        <!-- Anime cards will be injected here -->
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="hidden text-center py-20">
        <svg class="mx-auto h-12 w-12 text-gray-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
        <h3 class="text-lg font-medium text-white">No anime scheduled for this day</h3>
        <p class="text-gray-400 mt-2">Check another day or come back later.</p>
    </div>
</div>

<style>
    .anime-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .anime-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
    }
</style>

<script>
    let currentDay = '{{ today }}';
    const days = {{ days | tojson }};
    let allScheduleData = {};

    async function fetchSchedule(day) {
        document.getElementById('loading-spinner').classList.remove('hidden');
        document.getElementById('schedule-content').classList.add('hidden');
        document.getElementById('empty-state').classList.add('hidden');

        try {
            const response = await fetch(`/api/schedule?day=${day}`);
            const data = await response.json();

            renderSchedule(data);
        } catch (error) {
            console.error('Error fetching schedule:', error);
            showEmpty();
        } finally {
            document.getElementById('loading-spinner').classList.add('hidden');
        }
    }

    function renderSchedule(animeList) {
        const container = document.getElementById('schedule-content');
        container.innerHTML = '';

        if (!animeList || animeList.length === 0) {
            showEmpty();
            return;
        }

        animeList.forEach(anime => {
            const card = document.createElement('div');
            card.className = 'anime-card bg-gray-800 rounded-xl overflow-hidden flex flex-col h-full border border-gray-700';

            const imageUrl = anime.images?.jpg?.large_image_url || anime.images?.jpg?.image_url || '/static/no-cover.jpg';
            const broadcast = anime.broadcast?.string || 'Time Unknown';
            const score = anime.score ? `â˜… ${anime.score}` : 'N/A';

            card.innerHTML = `
                <div class="relative group cursor-pointer" onclick="window.location.href='/anime/${anime.mal_id}'">
                    <img src="${imageUrl}" alt="${anime.title}" class="w-full h-64 object-cover">
                    <div class="absolute inset-0 bg-black bg-opacity-40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                        <span class="bg-indigo-600 text-white px-4 py-2 rounded-full font-bold">Details</span>
                    </div>
                    <div class="absolute top-2 right-2 bg-black bg-opacity-70 text-yellow-500 px-2 py-1 rounded text-xs font-bold">
                        ${score}
                    </div>
                    <div class="absolute bottom-2 left-2 bg-indigo-600 text-white px-2 py-1 rounded text-xs font-bold">
                        ${anime.type || 'TV'}
                    </div>
                </div>
                <div class="p-4 flex-grow flex flex-col">
                    <h3 class="text-white font-bold text-sm mb-1 line-clamp-2 hover:text-indigo-400 cursor-pointer" onclick="window.location.href='/anime/${anime.mal_id}'">
                        ${anime.title}
                    </h3>
                    <p class="text-gray-400 text-xs mb-3 flex items-center">
                        <svg class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        ${broadcast}
                    </p>
                    <div class="mt-auto flex space-x-2">
                        <a href="/player?mal_id=${anime.mal_id}" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white text-center py-2 rounded text-xs font-bold transition-colors">
                            Watch
                        </a>
                        <button onclick="addToWatchlist(${anime.mal_id})" class="p-2 bg-gray-700 hover:bg-gray-600 text-white rounded transition-colors" title="Add to Watchlist">
                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });

        container.classList.remove('hidden');
    }

    function showEmpty() {
        document.getElementById('empty-state').classList.remove('hidden');
    }

    function switchDay(day) {
        currentDay = day;

        // Update tabs
        document.querySelectorAll('.day-tab').forEach(tab => {
            tab.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg');
            tab.classList.add('text-gray-400', 'hover:text-white', 'hover:bg-gray-700');
        });

        const activeTab = document.getElementById(`tab-${day}`);
        activeTab.classList.add('bg-indigo-600', 'text-white', 'shadow-lg');
        activeTab.classList.remove('text-gray-400', 'hover:text-white', 'hover:bg-gray-700');

        fetchSchedule(day);
    }

    function addToWatchlist(malId) {
        fetch('/api/user/watchlist/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                mal_id: malId,
                status: 'plan-to-watch'
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Added to Plan to Watch!', 'success');
            } else {
                if (data.error === 'Unauthorized') {
                    window.location.href = '/login';
                } else {
                    showNotification(data.error || 'Failed to add to watchlist', 'error');
                }
            }
        })
        .catch((error) => {
            console.error('Error:', error);
            showNotification('An error occurred', 'error');
        });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        fetchSchedule(currentDay);
    });
</script>
{% endblock %}
