{% extends "base.html" %}

{% block content %}
<div class="relative mb-8">
    <!-- Backdrop Banner -->
    <div class="absolute inset-0 h-64 md:h-96 overflow-hidden rounded-xl opacity-30">
        <img src="{{ anime.cover_local or anime.cover_url }}" class="w-full h-full object-cover filter blur-xl scale-110" alt="Banner">
        <div class="absolute inset-0 bg-gradient-to-t from-gray-900 via-gray-900/40 to-transparent"></div>
    </div>

    <!-- Main Content -->
    <div class="relative pt-10 md:pt-20 px-4 md:px-8 flex flex-col md:flex-row gap-8">
        <!-- Cover Art -->
        <div class="flex-shrink-0 mx-auto md:mx-0">
            <div class="w-56 md:w-64 rounded-xl shadow-2xl overflow-hidden border-4 border-gray-800 bg-gray-800">
                <img src="{{ anime.cover_local or anime.cover_url }}" class="w-full h-auto" alt="{{ anime.title }}">
            </div>
            <div class="mt-4 flex flex-col gap-2">
                {% if user_status %}
                <button class="w-full py-3 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition shadow-lg flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    {{ user_status.replace('-', ' ').title() }}
                </button>
                {% else %}
                <button onclick="addToWatchlist({{ anime.mal_id }})" class="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition shadow-lg flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    Add to Watchlist
                </button>
                {% endif %}
                <a href="/player?mal_id={{ anime.mal_id }}&ep=1" class="w-full py-3 px-4 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition shadow-lg flex items-center justify-center gap-2 text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg>
                    Watch Now
                </a>
            </div>
        </div>

        <!-- Info -->
        <div class="flex-grow">
            <h1 class="text-3xl md:text-5xl font-black mb-2 text-white leading-tight">{{ anime.title }}</h1>
            <h2 class="text-xl text-gray-400 mb-6 italic">{{ anime.title_japanese }}</h2>

            <div class="flex flex-wrap gap-3 mb-6">
                {% for genre in anime.genres %}
                <span class="px-3 py-1 bg-gray-800 text-blue-400 rounded-full text-sm font-semibold border border-gray-700 hover:bg-blue-900/30 transition cursor-default">
                    {{ genre.name }}
                </span>
                {% endfor %}
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-gray-800/50 p-3 rounded-lg border border-gray-700">
                    <p class="text-xs text-gray-400 uppercase tracking-widest mb-1">Score</p>
                    <p class="text-2xl font-bold text-yellow-500">⭐ {{ anime.score or 'N/A' }}</p>
                </div>
                <div class="bg-gray-800/50 p-3 rounded-lg border border-gray-700">
                    <p class="text-xs text-gray-400 uppercase tracking-widest mb-1">Rank</p>
                    <p class="text-2xl font-bold text-blue-400">#{{ anime.rank or 'N/A' }}</p>
                </div>
                <div class="bg-gray-800/50 p-3 rounded-lg border border-gray-700">
                    <p class="text-xs text-gray-400 uppercase tracking-widest mb-1">Episodes</p>
                    <p class="text-2xl font-bold text-green-400">{{ anime.episodes or '?' }}</p>
                </div>
                <div class="bg-gray-800/50 p-3 rounded-lg border border-gray-700">
                    <p class="text-xs text-gray-400 uppercase tracking-widest mb-1">Type</p>
                    <p class="text-2xl font-bold text-purple-400">{{ anime.type or 'TV' }}</p>
                </div>
            </div>

            <div class="prose prose-invert max-w-none mb-8">
                <h3 class="text-xl font-bold mb-3 border-b border-gray-700 pb-2">Synopsis</h3>
                <p class="text-gray-300 leading-relaxed text-lg">
                    {{ anime.synopsis or 'No synopsis available for this anime.' }}
                </p>
            </div>

            <div class="flex flex-col md:flex-row gap-8">
                <div>
                    <h4 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-2">Studios</h4>
                    <div class="flex gap-2">
                        {% for studio in anime.studios %}
                        <span class="text-white font-medium">{{ studio.name }}{% if not loop.last %}, {% endif %}</span>
                        {% endfor %}
                    </div>
                </div>
                <div>
                    <h4 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-2">Status</h4>
                    <span class="text-white font-medium">{{ anime.status }}</span>
                </div>
                <div>
                    <h4 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-2">Aired</h4>
                    <span class="text-white font-medium">{{ anime.aired_from }} to {{ anime.aired_to or 'Present' }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sources Section -->
<section class="mt-8 px-4 md:px-8">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl md:text-3xl font-black text-white border-l-4 border-blue-600 pl-4 uppercase tracking-tighter">Available Sources</h2>
        <div class="text-sm text-gray-400" id="sources-count">
            Loading sources...
        </div>
    </div>

    <div id="sources-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Sources will be loaded here -->
    </div>
</section>

<!-- Episodes Section -->
<section class="mt-12 px-4 md:px-8">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl md:text-3xl font-black text-white border-l-4 border-red-600 pl-4 uppercase tracking-tighter">Episodes</h2>
        <div class="text-sm text-gray-400">
            Total: {{ anime.episodes_list|length }} Episodes
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        {% for ep in anime.episodes_list %}
        <a href="/player?mal_id={{ anime.mal_id }}&ep={{ ep.episode_number }}"
           class="group relative bg-gray-800 rounded-lg overflow-hidden border border-gray-700 hover:border-red-600 transition-all duration-300 transform hover:-translate-y-1">
            <div class="aspect-video relative overflow-hidden bg-gray-900">
                <div class="absolute inset-0 flex items-center justify-center opacity-50 group-hover:opacity-100 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-white" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg>
                </div>
                <!-- Placeholder for Thumbnail -->
                <div class="w-full h-full bg-gradient-to-br from-gray-800 to-gray-900 flex items-center justify-center text-gray-700 font-bold text-4xl">
                    {{ ep.episode_number }}
                </div>
                {% if ep.video_count > 0 %}
                <div class="absolute top-2 right-2 bg-green-600 text-white text-[10px] font-black px-1.5 py-0.5 rounded uppercase shadow-lg">
                    HD
                </div>
                {% endif %}
            </div>
            <div class="p-4">
                <div class="flex justify-between items-start">
                    <h3 class="font-bold text-white group-hover:text-red-500 transition line-clamp-1">
                        {{ ep.title or 'Episode ' ~ ep.episode_number }}
                    </h3>
                </div>
                <div class="mt-2 flex items-center text-xs text-gray-500 gap-2">
                    <span class="font-bold">EP {{ ep.episode_number }}</span>
                    <span>•</span>
                    <span>Japanese Audio</span>
                </div>
            </div>
        </a>
        {% endfor %}
    </div>
</section>

<!-- Reviews Section -->
<section class="mt-12 px-4 md:px-8 mb-16">
    <div class="flex items-center justify-between mb-8">
        <div class="flex items-center gap-4">
            <h2 class="text-2xl md:text-3xl font-black text-white border-l-4 border-yellow-500 pl-4 uppercase tracking-tighter">Reviews</h2>
            <span id="reviews-count" class="bg-gray-800 text-gray-400 px-3 py-1 rounded-full text-sm font-bold">0</span>
        </div>
        <button onclick="openReviewModal()" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-black py-2 px-6 rounded-lg transition transform hover:scale-105 active:scale-95 shadow-lg flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
            </svg>
            Write a Review
        </button>
    </div>

    <!-- Review Loading State -->
    <div id="reviews-loading" class="flex flex-col items-center justify-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-yellow-500"></div>
        <p class="mt-4 text-gray-400">Loading reviews...</p>
    </div>

    <!-- Reviews List -->
    <div id="reviews-list" class="grid grid-cols-1 gap-6 hidden">
        <!-- Reviews will be injected here -->
    </div>

    <!-- No Reviews State -->
    <div id="no-reviews" class="hidden bg-gray-800/30 border-2 border-dashed border-gray-700 rounded-2xl p-12 text-center">
        <div class="text-6xl mb-4">✍️</div>
        <h3 class="text-xl font-bold text-white mb-2">No reviews yet</h3>
        <p class="text-gray-400 mb-6">Be the first to share your thoughts on this anime!</p>
        <button onclick="openReviewModal()" class="text-yellow-500 font-bold hover:underline">Write the first review</button>
    </div>
</section>

<!-- Review Modal -->
<div id="review-modal" class="fixed inset-0 z-[100] hidden">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-md" onclick="closeReviewModal()"></div>
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-2xl px-4">
        <div class="bg-gray-900 border border-gray-700 rounded-2xl shadow-2xl overflow-hidden">
            <div class="p-6 border-b border-gray-800 flex items-center justify-between">
                <h3 class="text-xl font-black text-white uppercase tracking-tight">Submit Your Review</h3>
                <button onclick="closeReviewModal()" class="text-gray-400 hover:text-white transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <form id="review-form" class="p-6 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-bold text-gray-400 uppercase mb-2">Your Rating</label>
                        <div class="flex items-center gap-2 bg-gray-800 p-2 rounded-lg border border-gray-700">
                            <input type="range" id="review-score" min="1" max="10" value="10" class="flex-grow accent-yellow-500 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                            <span id="score-display" class="text-2xl font-black text-yellow-500 w-12 text-center">10</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-400 uppercase mb-2">Spoilers?</label>
                        <label class="flex items-center gap-3 cursor-pointer bg-gray-800 p-3 rounded-lg border border-gray-700">
                            <input type="checkbox" id="review-is-spoiler" class="w-5 h-5 rounded border-gray-700 bg-gray-900 text-red-600 focus:ring-red-500">
                            <span class="text-white font-medium">Contains Spoilers</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-400 uppercase mb-2">Review Title (Optional)</label>
                    <input type="text" id="review-title" placeholder="A masterpiece!" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:outline-none focus:border-yellow-500 transition">
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-400 uppercase mb-2">Your Thoughts</label>
                    <textarea id="review-content" rows="6" required placeholder="Tell others what you think about this anime..." class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:outline-none focus:border-yellow-500 transition resize-none"></textarea>
                </div>

                <div class="flex justify-end gap-3 pt-2">
                    <button type="button" onclick="closeReviewModal()" class="px-6 py-2 rounded-lg font-bold text-gray-400 hover:text-white transition">Cancel</button>
                    <button type="submit" class="px-8 py-3 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-black rounded-lg transition shadow-lg transform active:scale-95">
                        Submit Review
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Global variables
    let animeSources = [];

    // Load sources when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadAnimeSources();
    });

    async function loadAnimeSources() {
        try {
            const response = await fetch(`/api/anime/{{ anime.mal_id }}/sources`);
            const data = await response.json();

            if (data.sources) {
                animeSources = data.sources;
                displaySources(data.sources);
            } else {
                document.getElementById('sources-container').innerHTML = '<p class="text-gray-400">No sources found for this anime.</p>';
            }

            document.getElementById('sources-count').textContent = `${data.sources ? data.sources.length : 0} Sources`;
        } catch (error) {
            console.error('Error loading sources:', error);
            document.getElementById('sources-container').innerHTML = '<p class="text-red-400">Error loading sources.</p>';
            document.getElementById('sources-count').textContent = 'Error';
        }
    }

    function displaySources(sources) {
        const container = document.getElementById('sources-container');

        if (sources.length === 0) {
            container.innerHTML = '<p class="text-gray-400">No sources found for this anime.</p>';
            return;
        }

        const sourceCards = sources.map(source => `
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 mb-4">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-bold text-white capitalize">${source.name}</h3>
                    <span class="px-2 py-1 bg-blue-600 text-white text-xs rounded-full">${source.name}</span>
                </div>

                <div class="mb-3">
                    <p class="text-sm text-gray-400 truncate" title="${source.source_title || source.source_slug}">
                        ${source.source_title || source.source_slug || 'N/A'}
                    </p>
                </div>

                <div class="flex gap-2 mb-4">
                    <button onclick="fetchEpisodes('${source.name}')"
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center justify-center gap-2 text-sm"
                            id="fetch-btn-${source.name}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        Fetch Episodes
                    </button>

                    <a href="${source.base_url || '#'}" target="_blank"
                       class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-lg transition flex items-center justify-center text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                        </svg>
                    </a>
                </div>

                <!-- Episodes for this source -->
                <div id="episodes-${source.name}" class="border-t border-gray-700 pt-4">
                    <div class="text-sm text-gray-400 mb-2">Episodes from ${source.name}:</div>
                    <div id="episodes-list-${source.name}" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                        <!-- Episodes will be loaded here -->
                    </div>
                </div>
            </div>
        `).join('');

        container.innerHTML = sourceCards;

        // Load episodes for each source
        sources.forEach(source => {
            loadSourceEpisodes(source.name);
        });
    }

    async function fetchEpisodes(sourceName) {
        const button = document.getElementById(`fetch-btn-${sourceName}`);
        const originalText = button.innerHTML;

        // Disable button and show loading
        button.disabled = true;
        button.innerHTML = `
            <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Fetching...
        `;

        try {
            const response = await fetch(`/api/anime/{{ anime.mal_id }}/fetch-episodes/${sourceName}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            const data = await response.json();

            if (data.success) {
                showNotification(data.message, 'success');
                // Reload episodes for this source
                setTimeout(() => {
                    loadSourceEpisodes(sourceName);
                }, 500);
            } else {
                showNotification(data.error || 'Failed to fetch episodes', 'error');
                // Reset button
                button.disabled = false;
                button.innerHTML = originalText;
            }
        } catch (error) {
            console.error('Error fetching episodes:', error);
            showNotification('Network error while fetching episodes', 'error');
            // Reset button
            button.disabled = false;
            button.innerHTML = originalText;
        }
    }

    async function loadSourceEpisodes(sourceName) {
        const container = document.getElementById(`episodes-list-${sourceName}`);
        
        try {
            // Load episodes from database
            const response = await fetch(`/api/anime/{{ anime.mal_id }}/episodes`);
            const data = await response.json();
            
            if (data.episodes && data.episodes.length > 0) {
                const episodeCards = data.episodes.map(ep => `
                    <a href="/player?mal_id={{ anime.mal_id }}&ep=${ep.episode_number}&source=${sourceName}"
                       class="bg-gray-700 hover:bg-gray-600 rounded p-2 text-center text-sm text-white transition">
                        ${ep.episode_number}
                    </a>
                `).join('');
                container.innerHTML = episodeCards;
            } else {
                container.innerHTML = '<p class="text-gray-500 text-sm col-span-full">No episodes fetched yet</p>';
            }
        } catch (error) {
            console.error('Error loading episodes:', error);
            container.innerHTML = '<p class="text-red-500 text-sm col-span-full">Error loading episodes</p>';
        }
    }

    // Review System Logic
    document.addEventListener('DOMContentLoaded', function() {
        loadReviews();

        const scoreInput = document.getElementById('review-score');
        const scoreDisplay = document.getElementById('score-display');
        if (scoreInput) {
            scoreInput.addEventListener('input', () => {
                scoreDisplay.textContent = scoreInput.value;
            });
        }

        const reviewForm = document.getElementById('review-form');
        if (reviewForm) {
            reviewForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                await submitReview();
            });
        }
    });

    function openReviewModal() {
        document.getElementById('review-modal').classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }

    function closeReviewModal() {
        document.getElementById('review-modal').classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }

    async function loadReviews() {
        const loading = document.getElementById('reviews-loading');
        const list = document.getElementById('reviews-list');
        const noReviews = document.getElementById('no-reviews');
        const countDisplay = document.getElementById('reviews-count');

        try {
            const response = await fetch(`/api/reviews/{{ anime.mal_id }}`);
            const reviews = await response.json();

            loading.classList.add('hidden');
            countDisplay.textContent = reviews.length;

            if (reviews.length === 0) {
                noReviews.classList.remove('hidden');
                list.classList.add('hidden');
                return;
            }

            noReviews.classList.add('hidden');
            list.classList.remove('hidden');

            list.innerHTML = reviews.map(review => {
                const date = new Date(review.created_at).toLocaleDateString();
                const scoreColor = review.score >= 8 ? 'text-green-500' : review.score >= 5 ? 'text-yellow-500' : 'text-red-500';

                return `
                    <div class="bg-gray-800/40 rounded-2xl border border-gray-700 overflow-hidden hover:border-gray-600 transition group">
                        <div class="p-6">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <img src="https://api.dicebear.com/7.x/bottts/svg?seed=${review.username}" class="w-10 h-10 rounded-full bg-gray-700 border border-gray-600 shadow-sm" alt="${review.username}">
                                    <div>
                                        <a href="/user/${review.username}" class="font-bold text-white hover:text-blue-400 transition">${review.username}</a>
                                        <p class="text-xs text-gray-500">${date}</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 bg-gray-900/50 px-3 py-1.5 rounded-full border border-gray-700">
                                    <span class="text-xs font-black text-gray-500 uppercase tracking-widest">Score</span>
                                    <span class="text-lg font-black ${scoreColor}">${review.score}/10</span>
                                </div>
                            </div>

                            ${review.title ? `<h4 class="text-xl font-bold text-white mb-2">${escapeHTML(review.title)}</h4>` : ''}

                            <div class="relative">
                                ${review.is_spoiler ? `
                                    <div class="spoiler-container group/spoiler">
                                        <div class="filter blur-md select-none opacity-40 transition group-hover/spoiler:blur-none group-hover/spoiler:opacity-100 duration-500">
                                            <p class="text-gray-300 leading-relaxed whitespace-pre-wrap">${escapeHTML(review.content)}</p>
                                        </div>
                                        <div class="absolute inset-0 flex items-center justify-center group-hover/spoiler:hidden">
                                            <div class="bg-red-600/20 border border-red-500/50 text-red-500 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                                </svg>
                                                SPOILER REVIEW - HOVER TO VIEW
                                            </div>
                                        </div>
                                    </div>
                                ` : `
                                    <p class="text-gray-300 leading-relaxed whitespace-pre-wrap">${escapeHTML(review.content)}</p>
                                `}
                            </div>

                            <div class="mt-6 pt-6 border-t border-gray-700/50 flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <span class="text-sm text-gray-500">Was this helpful?</span>
                                    <div class="flex items-center bg-gray-900/50 rounded-lg border border-gray-700 p-1">
                                        <button onclick="voteReview(${review.id}, 1)" class="flex items-center gap-1.5 px-3 py-1 rounded-md transition ${review.user_vote === 1 ? 'bg-green-600/20 text-green-500' : 'text-gray-400 hover:bg-gray-800'}">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.704a2 2 0 012 2v1.2a3 3 0 01-.464 1.581l-3.096 4.856c-.516.81-1.412 1.303-2.373 1.303H7.83a2 2 0 01-2-2V10a2 2 0 01.586-1.414l4.414-4.414a2 2 0 012.828 0L14 4.586V10z" />
                                            </svg>
                                            <span class="text-xs font-bold">${review.helpful_count}</span>
                                        </button>
                                        <div class="w-px h-4 bg-gray-700 mx-1"></div>
                                        <button onclick="voteReview(${review.id}, -1)" class="flex items-center gap-1.5 px-3 py-1 rounded-md transition ${review.user_vote === -1 ? 'bg-red-600/20 text-red-500' : 'text-gray-400 hover:bg-gray-800'}">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.296a2 2 0 01-2-2V10.8a3 3 0 01.464-1.581l3.096-4.856c.516-.81 1.412-1.303 2.373-1.303h7.371a2 2 0 012 2v10a2 2 0 01-.586 1.414l-4.414 4.414a2 2 0 01-2.828 0L10 19.414V14z" />
                                            </svg>
                                            <span class="text-xs font-bold">${review.unhelpful_count}</span>
                                        </button>
                                    </div>
                                </div>
                                ${review.username === '{{ session.username }}' ? `
                                    <button onclick="deleteReview(${review.id})" class="text-xs font-bold text-gray-500 hover:text-red-500 transition uppercase tracking-tighter">Delete My Review</button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

        } catch (error) {
            console.error('Error loading reviews:', error);
            loading.innerHTML = '<p class="text-red-500">Failed to load reviews.</p>';
        }
    }

    async function submitReview() {
        const score = document.getElementById('review-score').value;
        const title = document.getElementById('review-title').value;
        const content = document.getElementById('review-content').value;
        const isSpoiler = document.getElementById('review-is-spoiler').checked;

        try {
            const response = await fetch('/api/reviews', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    mal_id: {{ anime.mal_id }},
                    score: parseInt(score),
                    title: title,
                    content: content,
                    is_spoiler: isSpoiler
                })
            });

            const data = await response.json();

            if (data.success) {
                showNotification('Review submitted successfully!', 'success');
                closeReviewModal();
                loadReviews();
                document.getElementById('review-form').reset();
            } else {
                showNotification(data.error || 'Failed to submit review', 'error');
            }
        } catch (error) {
            console.error('Error submitting review:', error);
            showNotification('Login required to submit a review!', 'error');
        }
    }

    async function voteReview(reviewId, vote) {
        try {
            const response = await fetch(`/api/reviews/${reviewId}/vote`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ vote: vote })
            });

            const data = await response.json();
            if (data.success) {
                loadReviews();
            } else {
                showNotification(data.error || 'Failed to vote', 'error');
            }
        } catch (error) {
            showNotification('Login required to vote!', 'error');
        }
    }

    async function deleteReview(reviewId) {
        if (!confirm('Are you sure you want to delete your review?')) return;

        try {
            const response = await fetch(`/api/reviews/${reviewId}`, {
                method: 'DELETE'
            });

            const data = await response.json();
            if (data.success) {
                showNotification('Review deleted', 'success');
                loadReviews();
            } else {
                showNotification(data.error || 'Failed to delete review', 'error');
            }
        } catch (error) {
            showNotification('Error deleting review', 'error');
        }
    }

    function escapeHTML(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    async function addToWatchlist(malId) {
        try {
            const resp = await fetch('/api/user/watchlist', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mal_id: malId, status: 'plan-to-watch' })
            });
            const data = await resp.json();
            if (data.success) {
                showNotification('Added to your watchlist!', 'success');
                location.reload();
            } else {
                showNotification(data.error || 'Failed to add', 'error');
            }
        } catch (e) {
            showNotification('Login required!', 'error');
        }
    }
</script>
{% endblock %}
