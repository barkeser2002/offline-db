{% extends "base.html" %}

{% block title %}Community - Anime Platform{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-8">
    <div class="text-center space-y-2">
        <h1 class="text-4xl font-extrabold text-white">Community Hub</h1>
        <p class="text-gray-400">Join the discussion and see who's leading the pack.</p>
    </div>

    <!-- Top Watchers Leaderboard -->
    <section class="bg-gray-800 rounded-2xl border border-gray-700 overflow-hidden shadow-2xl">
        <div class="bg-gradient-to-r from-blue-600 to-indigo-700 p-6">
            <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
                </svg>
                Top Watchers
            </h2>
        </div>
        <div class="p-0 overflow-x-auto">
            <table class="w-full text-left">
                <thead class="bg-gray-900/50 text-gray-400 text-xs uppercase font-bold">
                    <tr>
                        <th class="px-6 py-4">Rank</th>
                        <th class="px-6 py-4">User</th>
                        <th class="px-6 py-4">Level</th>
                        <th class="px-6 py-4">Episodes Watched</th>
                        <th class="px-6 py-4">Anime Count</th>
                        <th class="px-6 py-4 text-right">Profile</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-700/50">
                    {% for watcher in leaderboard %}
                    <tr class="hover:bg-gray-700/30 transition group">
                        <td class="px-6 py-4 font-bold text-gray-400 group-hover:text-white">
                            {% if loop.index == 1 %} <span class="text-2xl">ü•á</span>
                            {% elif loop.index == 2 %} <span class="text-2xl">ü•à</span>
                            {% elif loop.index == 3 %} <span class="text-2xl">ü•â</span>
                            {% else %} #{{ loop.index }}
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed={{ watcher.username }}" class="w-10 h-10 rounded-lg bg-gray-700 border border-gray-600" alt="">
                                <span class="font-bold text-blue-400">{{ watcher.username }}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="inline-flex items-center px-2 py-0.5 rounded bg-blue-500/10 border border-blue-500/20 text-blue-400 text-[10px] font-black uppercase tracking-widest">
                                LVL {{ watcher.level }}
                            </div>
                        </td>
                        <td class="px-6 py-4 font-mono text-indigo-400">{{ watcher.total_episodes }}</td>
                        <td class="px-6 py-4 text-gray-300">{{ watcher.anime_count }} series</td>
                        <td class="px-6 py-4 text-right">
                            <a href="/user/{{ watcher.username }}" class="bg-gray-700 hover:bg-blue-600 text-white px-4 py-1.5 rounded-lg text-sm transition font-semibold">View Stats</a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="p-12 text-center text-gray-500">No data available yet. Be the first!</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

    <!-- Global Activity Feed -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <div class="md:col-span-2 space-y-6">
            <h3 class="text-2xl font-bold flex items-center gap-2">
                <span class="w-2 h-8 bg-blue-500 rounded-full"></span>
                Recent Community Activity
            </h3>
            <div id="global-feed" class="space-y-4">
                <!-- Will be populated by JS or simple Loop -->
                <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 text-center text-gray-500 italic">
                    Loading social feed...
                </div>
            </div>
        </div>

        <div class="space-y-6">
            <div class="bg-blue-600/10 border border-blue-500/20 p-6 rounded-2xl">
                <h4 class="font-bold text-blue-400 mb-2">Did you know?</h4>
                <p class="text-sm text-gray-300 leading-relaxed">
                    Following other users lets you see their watch history and ratings in your personal activity feed. Stay updated with what your friends are watching!
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function loadGlobalActivity() {
        const feedContainer = document.getElementById('global-feed');
        try {
            const resp = await fetch('/api/social/global-feed?limit=20');
            const data = await resp.json();

            if (data.success && data.feed.length > 0) {
                feedContainer.innerHTML = data.feed.map(act => {
                    const safeUsername = escapeHTML(act.username);
                    const safeTarget = escapeHTML(act.target_username);
                    const safeAnime = escapeHTML(act.anime_title);
                    let icon = '‚ö°';
                    let actionText = act.message || '';

                    if (act.type === 'watch') icon = 'üëÅÔ∏è';
                    else if (act.type === 'favorite') icon = '‚ù§Ô∏è';
                    else if (act.type === 'comment') icon = 'üí¨';
                    else if (act.type === 'follow') icon = 'üë§';

                    return `
                        <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700/50 flex items-center gap-4 hover:bg-gray-700/30 transition group">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-500/20 to-blue-500/20 flex items-center justify-center text-xl border border-white/5">
                                ${icon}
                            </div>
                            <div class="flex-grow">
                                <p class="text-sm text-gray-300">
                                    <a href="/user/${safeUsername}" class="font-bold text-blue-400 hover:underline">${safeUsername}</a>
                                    <span class="text-gray-500">${actionText}</span>
                                </p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-[10px] text-gray-600 font-mono uppercase tracking-widest">${new Date(act.created_at).toLocaleString()}</span>
                                    ${act.mal_id ? `‚Ä¢ <a href="/anime/${act.mal_id}" class="text-[10px] text-purple-400 font-bold hover:underline">View Series</a>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                feedContainer.innerHTML = '<div class="bg-gray-800 p-6 rounded-xl border border-gray-700 text-center text-gray-500 italic">No community activity yet. Be the first!</div>';
            }
        } catch (e) {
            feedContainer.innerHTML = '<div class="bg-gray-800 p-6 rounded-xl border border-gray-700 text-center text-red-500/50 italic">Error loading community feed.</div>';
        }
    }
    loadGlobalActivity();
</script>
{% endblock %}
